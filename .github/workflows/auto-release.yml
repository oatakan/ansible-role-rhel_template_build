---
name: Automated Release Pipeline

on:
  # Only run after CI completes successfully
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main, master]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday for accumulated changes
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force a release even without changes'
        type: boolean
        default: false

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  # Check if we should proceed with release
  check-prerequisites:
    runs-on: ubuntu-latest
    outputs:
      should_proceed: ${{ steps.check.outputs.should_proceed }}
      trigger_reason: ${{ steps.check.outputs.trigger_reason }}
    steps:
      - name: Check release prerequisites
        id: check
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Workflow run conclusion: ${{ github.event.workflow_run.conclusion }}"
          
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            if [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
              echo "✅ CI workflow completed successfully"
              echo "should_proceed=true" >> $GITHUB_OUTPUT
              echo "trigger_reason=ci_success" >> $GITHUB_OUTPUT
            else
              echo "❌ CI workflow failed - blocking release"
              echo "should_proceed=false" >> $GITHUB_OUTPUT
              echo "trigger_reason=ci_failed" >> $GITHUB_OUTPUT
            fi
          elif [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "⏰ Scheduled release check"
            echo "should_proceed=true" >> $GITHUB_OUTPUT
            echo "trigger_reason=scheduled" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "🔧 Manual release trigger"
            echo "should_proceed=true" >> $GITHUB_OUTPUT
            echo "trigger_reason=manual" >> $GITHUB_OUTPUT
          else
            echo "❓ Unexpected trigger"
            echo "should_proceed=false" >> $GITHUB_OUTPUT
            echo "trigger_reason=unknown" >> $GITHUB_OUTPUT
          fi

  analyze-changes:
    runs-on: ubuntu-latest
    needs: check-prerequisites
    if: needs.check-prerequisites.outputs.should_proceed == 'true'
    outputs:
      should_release: ${{ steps.analyze.outputs.should_release }}
      version_bump: ${{ steps.analyze.outputs.version_bump }}
      release_notes: ${{ steps.analyze.outputs.release_notes }}
      changelog_entry: ${{ steps.analyze.outputs.changelog_entry }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r .github/scripts/requirements.txt

      - name: Analyze changes with AI
        id: analyze
        run: |
          python .github/scripts/ai_release_analyzer.py
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_RELEASE: ${{ github.event.inputs.force_release }}

      - name: Post analysis summary
        if: steps.analyze.outputs.should_release == 'true'
        run: |
          echo "### 🤖 AI Release Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ needs.check-prerequisites.outputs.trigger_reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**Recommended Version Bump:** ${{ steps.analyze.outputs.version_bump }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reasoning:**" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.analyze.outputs.analysis_reasoning }}" >> $GITHUB_STEP_SUMMARY

  create-release:
    needs: [check-prerequisites, analyze-changes]
    if: needs.analyze-changes.outputs.should_release == 'true' || github.event.inputs.force_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r .github/scripts/requirements.txt

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Calculate new version
        id: version
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          LATEST_VERSION=${LATEST_TAG#v}
          
          python -c "
          import semver
          version = semver.Version.parse('$LATEST_VERSION')
          bump_type = '${{ needs.analyze-changes.outputs.version_bump }}'
          
          if bump_type == 'major':
              new_version = version.bump_major()
          elif bump_type == 'minor':
              new_version = version.bump_minor()
          else:
              new_version = version.bump_patch()
          
          print(f'NEW_VERSION={new_version}')
          print(f'NEW_TAG=v{new_version}')
          " >> $GITHUB_OUTPUT

      - name: Update CHANGELOG.md
        run: |
          python .github/scripts/update_changelog.py \
            --version "${{ steps.version.outputs.NEW_VERSION }}" \
            --entry "${{ needs.analyze-changes.outputs.changelog_entry }}"

      - name: Update documentation with AI
        run: |
          python .github/scripts/ai_doc_updater.py \
            --version "${{ steps.version.outputs.NEW_VERSION }}"

      - name: Create release commit
        run: |
          git add -A
          git commit -m "chore: release ${{ steps.version.outputs.NEW_TAG }} [skip ci]

          ${{ needs.analyze-changes.outputs.changelog_entry }}"

      - name: Create and push tag
        run: |
          git tag -a "${{ steps.version.outputs.NEW_TAG }}" \
            -m "Release ${{ steps.version.outputs.NEW_TAG }}"
          git push origin ${GITHUB_REF#refs/heads/} "${{ steps.version.outputs.NEW_TAG }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.NEW_TAG }}
          name: ${{ steps.version.outputs.NEW_TAG }}
          body: ${{ needs.analyze-changes.outputs.release_notes }}
          draft: false
          prerelease: false

  deploy-galaxy:
    needs: [check-prerequisites, analyze-changes, create-release]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-release.outputs.tag_name }}

      - name: Install ansible-core
        run: |
          pip install ansible-core

      - name: Import to Ansible Galaxy
        env:
          ANSIBLE_GALAXY_API_KEY: ${{ secrets.ANSIBLE_GALAXY_API_KEY }}
        run: |
          # Use the exact GitHub repository name for Galaxy import
          # Repository: oatakan/ansible-role-rhel_template_build
          ansible-galaxy role import \
            --api-key="${ANSIBLE_GALAXY_API_KEY}" \
            oatakan ansible-role-rhel_template_build

      - name: Verify Galaxy import
        run: |
          sleep 30  # Wait for Galaxy to process
          ansible-galaxy role info oatakan.rhel_template_build

  notify:
    needs: [create-release, deploy-galaxy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send notification
        run: |
          if [ "${{ needs.deploy-galaxy.result }}" == "success" ]; then
            echo "✅ Release successfully deployed to Ansible Galaxy!" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Release process failed. Check logs for details." >> $GITHUB_STEP_SUMMARY
          fi
