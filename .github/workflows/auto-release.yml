---
name: Automated Release Pipeline

on:
  # Simple push trigger - but with smart filtering to prevent loops
  push:
    branches: [main, master]
    # Ignore pushes that only affect documentation/release files
    paths-ignore:
      - 'CHANGELOG.md'
      - 'docs/**'
      - '*.md'
      - '.github/workflows/post-release-updates.yml'
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday for accumulated changes
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force a release even without changes'
        type: boolean
        default: false

env:
  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  # Check if we should skip this release cycle
  check-release-needed:
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.check.outputs.should_skip }}
      skip_reason: ${{ steps.check.outputs.skip_reason }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Get current and previous commit

      - name: Check if release should be skipped
        id: check
        run: |
          # Get the latest commit info
          COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
          COMMIT_EMAIL=$(git log -1 --pretty=format:"%ae")
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          
          echo "Commit author: $COMMIT_AUTHOR"
          echo "Commit email: $COMMIT_EMAIL"
          echo "Commit message: $COMMIT_MSG"
          
          # Skip if this was made by github-actions bot
          if [[ "$COMMIT_AUTHOR" == "github-actions[bot]" ]] || [[ "$COMMIT_EMAIL" == *"github-actions"* ]]; then
            echo "‚ö†Ô∏è Skipping release - commit made by GitHub Actions bot"
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "skip_reason=bot_commit" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Skip if commit message indicates a release or post-release update
          if [[ "$COMMIT_MSG" == *"chore: release"* ]] || [[ "$COMMIT_MSG" == *"post-release updates"* ]] || [[ "$COMMIT_MSG" == *"[skip release]"* ]]; then
            echo "‚ö†Ô∏è Skipping release - commit appears to be release-related"
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "skip_reason=release_commit" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if only documentation files changed
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files: $CHANGED_FILES"
          
          # Count non-documentation changes
          NON_DOC_CHANGES=$(echo "$CHANGED_FILES" | grep -v -E '\.(md|txt)$|^docs/|^CHANGELOG|^\.github/workflows/post-release' | wc -l)
          
          if [[ $NON_DOC_CHANGES -eq 0 ]] && [[ -n "$CHANGED_FILES" ]]; then
            echo "‚ö†Ô∏è Skipping release - only documentation files changed"
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "skip_reason=docs_only" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Proceed with release
          echo "‚úÖ Release should proceed - meaningful code changes detected"
          echo "should_skip=false" >> $GITHUB_OUTPUT
          echo "skip_reason=none" >> $GITHUB_OUTPUT

  analyze-changes:
    runs-on: ubuntu-latest
    needs: check-release-needed
    # Only run if we shouldn't skip
    if: needs.check-release-needed.outputs.should_skip == 'false'
    outputs:
      should_release: ${{ steps.analyze.outputs.should_release }}
      version_bump: ${{ steps.analyze.outputs.version_bump }}
      new_version: ${{ steps.analyze.outputs.new_version }}
      analysis_reasoning: ${{ steps.analyze.outputs.analysis_reasoning }}
      changelog_entry: ${{ steps.analyze.outputs.changelog_entry }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r .github/scripts/requirements.txt

      - name: Analyze changes with AI
        id: analyze
        run: |
          echo "ü§ñ Running AI release analysis..."
          
          # Run the AI analysis and capture output
          python .github/scripts/ai_release_analyzer.py > ai_analysis_output.log 2>&1
          
          # Display the output for debugging
          echo "üìã AI Analysis Output:"
          cat ai_analysis_output.log
          
          # Parse the output from the log
          if grep -q "üìã Analysis:" ai_analysis_output.log; then
            # Extract version bump from output
            VERSION_BUMP=$(grep "üìã Analysis:" ai_analysis_output.log | sed 's/.*Analysis: \([a-z]*\) bump.*/\1/')
            NEW_VERSION=$(grep "üìã Analysis:" ai_analysis_output.log | sed 's/.*‚Üí \(v[0-9.]*\).*/\1/')
            REASONING=$(grep "üí≠ Reasoning:" ai_analysis_output.log | sed 's/üí≠ Reasoning: //')
            
            echo "üìä Parsed Results:"
            echo "- Version Bump: $VERSION_BUMP"
            echo "- New Version: $NEW_VERSION" 
            echo "- Reasoning: $REASONING"
            
            # Set outputs
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version_bump=$VERSION_BUMP" >> $GITHUB_OUTPUT
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "analysis_reasoning=$REASONING" >> $GITHUB_OUTPUT
            echo "changelog_entry=- $REASONING" >> $GITHUB_OUTPUT
            
            # Create analysis file for other jobs
            cat > /tmp/release_analysis.json << EOF
          {
            "should_release": true,
            "version_bump": "$VERSION_BUMP",
            "new_version": "$NEW_VERSION",
            "reasoning": "$REASONING"
          }
          EOF
            
            echo "‚úÖ Analysis completed successfully"
          else
            echo "‚ùå Could not parse AI analysis output"
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "analysis_reasoning=Failed to parse AI analysis output" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Post analysis summary
        if: steps.analyze.outputs.should_release == 'true'
        run: |
          echo "### ü§ñ AI Release Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Strategy:** Branch protection (CI pre-validated on PRs)" >> $GITHUB_STEP_SUMMARY
          echo "**Loop Prevention:** Passed (no bot commits or docs-only changes)" >> $GITHUB_STEP_SUMMARY
          echo "**Recommended Version Bump:** ${{ steps.analyze.outputs.version_bump }}" >> $GITHUB_STEP_SUMMARY
          echo "**New Version:** ${{ steps.analyze.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reasoning:**" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.analyze.outputs.analysis_reasoning }}" >> $GITHUB_STEP_SUMMARY

  create-release:
    needs: [check-release-needed, analyze-changes]
    if: needs.check-release-needed.outputs.should_skip == 'false' && (needs.analyze-changes.outputs.should_release == 'true' || github.event.inputs.force_release == 'true')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Debug job inputs
        run: |
          echo "üîç Debugging job inputs from analyze-changes..."
          echo ""
          echo "Job outputs received:"
          echo "- should_release: '${{ needs.analyze-changes.outputs.should_release }}'"
          echo "- version_bump: '${{ needs.analyze-changes.outputs.version_bump }}'"
          echo "- new_version: '${{ needs.analyze-changes.outputs.new_version }}'"
          echo "- analysis_reasoning: '${{ needs.analyze-changes.outputs.analysis_reasoning }}'"
          echo "- changelog_entry: '${{ needs.analyze-changes.outputs.changelog_entry }}'"
          echo ""
          
          # Check if any are empty
          if [ -z "${{ needs.analyze-changes.outputs.new_version }}" ]; then
            echo "‚ùå CRITICAL: new_version is empty!"
          else
            echo "‚úÖ new_version received: ${{ needs.analyze-changes.outputs.new_version }}"
          fi
          
          if [ -z "${{ needs.analyze-changes.outputs.version_bump }}" ]; then
            echo "‚ùå CRITICAL: version_bump is empty!"
          else
            echo "‚úÖ version_bump received: ${{ needs.analyze-changes.outputs.version_bump }}"
          fi

      - name: Set version from AI analysis
        id: version
        run: |
          # Use AI analysis results directly
          AI_NEW_VERSION="${{ needs.analyze-changes.outputs.new_version }}"
          AI_VERSION_BUMP="${{ needs.analyze-changes.outputs.version_bump }}"
          
          echo "ü§ñ AI Analysis Results:"
          echo "- New Version: $AI_NEW_VERSION"
          echo "- Version Bump: $AI_VERSION_BUMP"
          
          # Validate we have the required outputs
          if [ -z "$AI_NEW_VERSION" ] || [ "$AI_NEW_VERSION" = "null" ]; then
            echo "‚ùå ERROR: No new version from AI analysis"
            echo "Available outputs:"
            echo "- should_release: ${{ needs.analyze-changes.outputs.should_release }}"
            echo "- version_bump: ${{ needs.analyze-changes.outputs.version_bump }}"
            echo "- new_version: ${{ needs.analyze-changes.outputs.new_version }}"
            exit 1
          fi
          
          # Use AI-determined version directly
          NEW_VERSION=${AI_NEW_VERSION#v}  # Remove 'v' prefix for version
          NEW_TAG="$AI_NEW_VERSION"       # Keep 'v' prefix for tag
          
          echo "üè∑Ô∏è Final version: $NEW_VERSION"
          echo "üè∑Ô∏è Final tag: $NEW_TAG"
          
          # Verify tag doesn't already exist
          if git tag -l | grep -q "^${NEW_TAG}$"; then
            echo "‚ùå Tag $NEW_TAG already exists!"
            echo "üîç Existing tags:"
            git tag -l | sort -V | tail -5
            echo ""
            echo "ü§ñ This suggests the AI analysis or version calculation has an issue."
            exit 1
          fi
          
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "VERSION_BUMP=$AI_VERSION_BUMP" >> $GITHUB_OUTPUT

      # Don't commit changes to master - just create the tag and release
      - name: Create and push tag (using AI version)
        run: |
          # Configure git user for tag creation
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          NEW_TAG="${{ steps.version.outputs.NEW_TAG }}"
          NEW_VERSION="${{ steps.version.outputs.NEW_VERSION }}"
          
          echo "üè∑Ô∏è Creating tag: $NEW_TAG"
          echo "üì¶ Version: $NEW_VERSION"
          echo "ü§ñ AI suggested: ${{ needs.analyze-changes.outputs.new_version }}"
          echo "üìä Version bump: ${{ needs.analyze-changes.outputs.version_bump }}"
          
          # Verify this is the correct version
          if [ "$NEW_TAG" != "${{ needs.analyze-changes.outputs.new_version }}" ]; then
            echo "‚ö†Ô∏è WARNING: Tag ($NEW_TAG) doesn't match AI suggestion (${{ needs.analyze-changes.outputs.new_version }})"
          fi
          
          # Double-check tag doesn't exist
          if git tag -l | grep -q "^${NEW_TAG}$"; then
            echo "‚ùå ERROR: Tag $NEW_TAG already exists!"
            echo "üîç Current tags:"
            git tag -l | sort -V
            echo ""
            echo "ü§ñ AI suggested version: ${{ needs.analyze-changes.outputs.new_version }}"
            echo "üìä Version bump type: ${{ needs.analyze-changes.outputs.version_bump }}"
            echo "üîß Calculated tag: $NEW_TAG"
            echo ""
            echo "This indicates a logic error in version calculation."
            exit 1
          fi
          
          # Create the tag with release notes
          git tag -a "$NEW_TAG" \
            -m "Release $NEW_TAG

          ${{ needs.analyze-changes.outputs.changelog_entry }}"
          
          echo "‚úÖ Tag created successfully"
          
          # Push the tag
          git push origin "$NEW_TAG"
          
          echo "‚úÖ Tag pushed to remote"

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.NEW_TAG }}
          release_name: Release ${{ steps.version.outputs.NEW_TAG }}
          body: |
            ## Changes in ${{ steps.version.outputs.NEW_TAG }}

            ${{ needs.analyze-changes.outputs.changelog_entry }}

            **Release Type:** ${{ needs.analyze-changes.outputs.version_bump }}
            **Analysis:** ${{ needs.analyze-changes.outputs.analysis_reasoning }}

            ---
            *This release was automatically generated based on AI analysis of the changes.*
          draft: false
          prerelease: false

  deploy-galaxy:
    needs: [check-release-needed, analyze-changes, create-release]
    if: needs.check-release-needed.outputs.should_skip == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.create-release.outputs.tag_name }}

      - name: Install ansible-core
        run: |
          pip install ansible-core

      - name: Import to Ansible Galaxy
        env:
          ANSIBLE_GALAXY_API_KEY: ${{ secrets.ANSIBLE_GALAXY_API_KEY }}
        run: |
          # Use the exact GitHub repository name for Galaxy import
          # Repository: oatakan/ansible-role-rhel_template_build
          ansible-galaxy role import \
            --api-key="${ANSIBLE_GALAXY_API_KEY}" \
            oatakan ansible-role-rhel_template_build

      - name: Verify Galaxy import
        run: |
          sleep 30  # Wait for Galaxy to process
          ansible-galaxy role info oatakan.rhel_template_build

  notify:
    needs: [check-release-needed, analyze-changes, create-release, deploy-galaxy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Debug workflow results
        run: |
          echo "### üîç Workflow Debug Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| check-release-needed | ${{ needs.check-release-needed.result }} | should_skip: ${{ needs.check-release-needed.outputs.should_skip }} |" >> $GITHUB_STEP_SUMMARY
          echo "| analyze-changes | ${{ needs.analyze-changes.result }} | should_release: ${{ needs.analyze-changes.outputs.should_release }} |" >> $GITHUB_STEP_SUMMARY
          echo "| create-release | ${{ needs.create-release.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| deploy-galaxy | ${{ needs.deploy-galaxy.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Send notification
        run: |
          if [[ "${{ needs.check-release-needed.outputs.should_skip }}" == "true" ]]; then
            echo "### ‚è≠Ô∏è Release Skipped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            case "${{ needs.check-release-needed.outputs.skip_reason }}" in
              "bot_commit")
                echo "**Reason:** Commit made by GitHub Actions bot (prevents infinite loops)" >> $GITHUB_STEP_SUMMARY
                ;;
              "release_commit")
                echo "**Reason:** Commit appears to be release-related" >> $GITHUB_STEP_SUMMARY
                ;;
              "docs_only")
                echo "**Reason:** Only documentation files were changed" >> $GITHUB_STEP_SUMMARY
                ;;
              *)
                echo "**Reason:** ${{ needs.check-release-needed.outputs.skip_reason }}" >> $GITHUB_STEP_SUMMARY
                ;;
            esac
          elif [[ "${{ needs.analyze-changes.outputs.should_release }}" != "true" ]]; then
            echo "### üìä Release Analysis: No Release Needed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**AI Analysis Result:** ${{ needs.analyze-changes.outputs.analysis_reasoning }}" >> $GITHUB_STEP_SUMMARY
            echo "**Recommended Action:** No version bump required" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.create-release.result }}" == "success" && "${{ needs.deploy-galaxy.result }}" == "success" ]]; then
            echo "### ‚úÖ Release Successfully Deployed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üéâ **New version deployed to Ansible Galaxy**" >> $GITHUB_STEP_SUMMARY
            echo "üì¶ **Version:** ${{ needs.analyze-changes.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            echo "‚è±Ô∏è **Completion Time:** $(( $(date +%s) - $(date -d '${{ github.event.head_commit.timestamp }}' +%s) )) seconds from push" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.create-release.result }}" == "skipped" ]]; then
            echo "### ‚ö†Ô∏è Release Jobs Skipped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Analysis Says Release:** ${{ needs.analyze-changes.outputs.should_release }}" >> $GITHUB_STEP_SUMMARY
            echo "**Should Skip:** ${{ needs.check-release-needed.outputs.should_skip }}" >> $GITHUB_STEP_SUMMARY
            echo "**Likely Issue:** Conditional logic problem in workflow" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Debug Info:**" >> $GITHUB_STEP_SUMMARY
            echo "- Check the workflow conditional statements" >> $GITHUB_STEP_SUMMARY
            echo "- Verify AI script outputs are being set correctly" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Release Process Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Failed Job:** " >> $GITHUB_STEP_SUMMARY
            if [[ "${{ needs.create-release.result }}" == "failure" ]]; then
              echo "- create-release (check release creation logs)" >> $GITHUB_STEP_SUMMARY
            fi
            if [[ "${{ needs.deploy-galaxy.result }}" == "failure" ]]; then
              echo "- deploy-galaxy (check Galaxy deployment logs)" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Check the individual job logs for detailed error information.**" >> $GITHUB_STEP_SUMMARY
          fi
